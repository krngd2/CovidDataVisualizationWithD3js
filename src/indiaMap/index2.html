<!DOCTYPE html>
<html lang="en">

<head>
    <!-- India State Map  -->
    <title>India Map</title>

    <!--  Scripts  -->
    <script type="text/javascript" src="js/d3.min.js"></script>
    <script type="text/javascript" src="js/d3.geo.min.js"></script>

    <!--  Styles  -->
    <link type="text/css" rel="stylesheet" href="css/index.css" />
    <style type="text/css">
        svg {
            background: #eee;
        }

        #india {
            fill: #fff;
            opacity: 1;
            stroke: #000000;
            stroke-width: .6;
        }
    </style>
</head>

<body>
    <div id="chart"></div>
    <script type="text/javascript" src=""></script>
    <script type="text/javascript">
        const monthsNames = {
            'Jan': '01',
            'Feb': '02',
            'Mar': '03',
            'Apr': '04',
            'May': '05',
            'Jun': '06',
            'Jul': '07',
            'Aug': '08',
            'Sep': '09',
            'Oct': '10',
            'Nov': '11',
            'Dec': '12'
        }
        const stateCodes = {
            'un': "State Unassigned",
            'an': "Andaman & Nicobar Island",
            'ap': "Andhra Pradesh",
            'ar': "Arunachal Pradesh",
            'as': "Assam",
            'br': "Bihar",
            'ch': "Chandigarh",
            'ct': "Chhattisgarh",
            'dl': "NCT of Delhi",
            'dn': "Dadra and Nagar Haveli and Daman and Diu",
            'ga': "Goa",
            'gj': "Gujarat",
            'hp': "Himachal Pradesh",
            'hr': "Haryana",
            'jh': "Jharkhand",
            'jk': "Jammu & Kashmir",
            'ka': "Karnataka",
            'kl': "Kerala",
            'la': "Ladakh",
            'ld': "Lakshadweep",
            'mh': "Maharashtra",
            'ml': "Meghalaya",
            'mn': "Manipur",
            'mp': "Madhya Pradesh",
            'mz': "Mizoram",
            'nl': "Nagaland",
            'or': "Odisha",
            'pb': "Punjab",
            'py': "Puducherry",
            'rj': "Rajasthan",
            'sk': "Sikkim",
            'tg': "Telangana",
            'tn': "Tamil Nadu",
            'tr': "Tripura",
            'up': "Uttar Pradesh",
            'ut': "Uttarakhand",
            'wb': "West Bengal",
        }
        let w = 600;
        let h = 650;
        let proj = d3.geo.mercator();
        let path = d3.geo.path().projection(proj);
        // let t = proj.translate(); // the projection's default translation
        // let s = proj.scale() // the projection's default scale
        let covidStateAllDates = new Set();

        let svg = d3.select("#chart")
            .append("svg:svg")
            .attr("width", w)
            .attr("height", h)
            .call(initialize);

        // let map = svg.append("svg:g")
        let india = svg.append("svg:g")
            .attr("id", "india");
        let indiaData = {}
        d3.json("https://api.covid19india.org/states_daily.json", (response) => {
            console.log(response);
            let totalCovidDataState = response.states_daily;
            for (let i = 0; i < 1; i = i + 3) {
                for (let p in totalCovidDataState[i]) {
                    if (p in stateCodes) {
                        indiaData[stateCodes[p]] = []
                    }
                }
            }
            for (let i = 0; i < totalCovidDataState.length; i = i + 3) {
                for (let p in totalCovidDataState[i]) {
                    if (p in stateCodes) {
                        let obj = {
                            confirmed: +totalCovidDataState[i][p],
                            recovered: +totalCovidDataState[i + 1][p],
                            deceased: +totalCovidDataState[i + 2][p],
                            date: convertDate(totalCovidDataState[i]['date'])
                        }
                        covidStateAllDates.add(convertDate(totalCovidDataState[i]['date']));
                        indiaData[stateCodes[p]].push(obj)
                    }
                }
            }
            for (let p in indiaData) {
                for (let j in indiaData[p]) {
                    if (+j > 0) {
                        indiaData[p][j].confirmed += indiaData[p][+j - 1].confirmed
                        indiaData[p][j].recovered += indiaData[p][+j - 1].recovered
                        indiaData[p][j].deceased += indiaData[p][+j - 1].deceased
                    }
                }
            }
            adjustData(indiaData);
        });


        async function adjustData(covidStateData) {
            updateChart = plotMap(covidStateData)
            playPlot()
        }

        async function playPlot(date) {
            // const timeParser = timeParse("%Y-%m-%d")
            if (date) {
                return updateChart(date)
            }
            for (let covidDate of covidStateAllDates) {
                updateChart(covidDate)
                await new Promise(done => setTimeout(() => done(), 800));
            }
        }

        function plotMap(covidData) {
            d3.json("data/states_india.json", function (data) {
                india.selectAll("path").data(data.features)
                    .enter()
                    .append('path')
                    .attr("class", "subunit")
                    .attr("d", path)
                    .style("stroke", "black")
                    .style("opacity", "1")
                    .style("stroke-width", "1px")
                    .attr("fill", (d) => {
                        if (d.properties.st_nm === "Daman & Diu" || d.properties.st_nm === "Dadara & Nagar Havelli") {
                            d.properties.st_nm = "Dadra and Nagar Haveli and Daman and Diu";
                        }
                        let todayStateData = covidData[d.properties.st_nm]?.filter((stateData) => {
                            return stateData.date === "2020-03-14";
                        });
                        let confirmedCases = todayStateData[0].confirmed;
                        if (confirmedCases === 0) { return "#C7C9C6"; }
                        else if (confirmedCases < 50) { return "#ffd6d6"; }
                        else if (confirmedCases < 100) { return "#ffacac"; }
                        else if (confirmedCases < 500) { return "#ff8181"; }
                        else if (confirmedCases < 1000) { return "#ff5454"; }
                        else if (confirmedCases < 5000) { return "#ff2625"; }
                        else if (confirmedCases < 10000) { return "#d50000"; }
                        else { return "#890000"; }
                    });
            });
            return (date) => {
                india.selectAll("path").transition()
                    .duration(800 / 1.2)
                    .attr("fill", (d) => {
                        if (d.properties.st_nm === "Daman & Diu" || d.properties.st_nm === "Dadara & Nagar Havelli") {
                            d.properties.st_nm = "Dadra and Nagar Haveli and Daman and Diu";
                        }
                        let todayStateData = covidData[d.properties.st_nm]?.filter((stateData) => {
                            return stateData.date === date;
                        });
                        let confirmedCases = todayStateData[0].confirmed;
                        if (confirmedCases === 0) { return "#C7C9C6"; }
                        else if (confirmedCases < 50) { return "#ffd6d6"; }
                        else if (confirmedCases < 100) { return "#ffacac"; }
                        else if (confirmedCases < 500) { return "#ff8181"; }
                        else if (confirmedCases < 1000) { return "#ff5454"; }
                        else if (confirmedCases < 5000) { return "#ff2625"; }
                        else if (confirmedCases < 10000) { return "#d50000"; }
                        else { return "#890000"; }
                    });
                    // .attr("text-anchor", "middle")
                    // .attr("dy", ".35em")
                    // .text( (d)=> {
                    //     return "5000";
                    // });
            }
        }
        function initialize() {
            proj.scale(6700);
            proj.translate([-1240, 750]);
        }

        function convertDate(dateString) {
            let dateEle = dateString.split('-')
            let corrDateForm = "20" + dateEle[2] + "-" + monthsNames[dateEle[1]] + "-" + dateEle[0]
            return corrDateForm
        }
    </script>
</body>

</html>